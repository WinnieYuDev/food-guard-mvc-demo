<!--
    views/index.ejs

    Purpose: Homepage template. Receives prepared data from
    `controllers/home.js` (see `cleanedTitle`, `cleanedReason`, `locations`,
    `categoryImage`) and renders recall cards and recent posts for demo/presentation.
-->
<%- include('partials/header') %>

<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <% if (typeof latestAlert !== 'undefined' && latestAlert && latestAlert.title) { %>
        <div class="mb-6 px-3 py-2 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">
            <marquee behavior="scroll" direction="left" scrollamount="4">
                <strong>Latest Alert:</strong>
                <a href="<%= latestAlert.articleLink || (latestAlert.rawData && latestAlert.rawData.field_recall_url) || '#' %>" target="_blank" rel="noopener noreferrer" class="underline">
                    <%= latestAlert.title %>
                </a>
            </marquee>
        </div>
    <% } %>
    <!--
        Homepage template variables (provided by controllers/home.js):
        - `recalls`: array of recall objects. Each recall has display-ready fields:
            - `cleanedTitle` (string): sanitized, title-cased headline
            - `cleanedReason` (string): sanitized short reason/summary
            - `locations` (string): comma-separated affected regions (preferred over agency)
            - `categoryImage` / `image` (string): URL to display for card image
        - `posts`: recent community posts
        - `user`: current logged-in user (optional)

        Use this section to understand what prepared fields the controller provides
        to the template. These fields are intended for display only and are
        already formatted by `controllers/home.js`.
    -->
    
    <div class="bg-gradient-to-r from-usda-blue to-usda-darkblue rounded-xl p-6 mb-8 text-white shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <% if (user) { %>
                        Welcome, <%= user.username %>!
                    <% } else { %>
                        Food Safety Alert System
                    <% } %>
                </h1>
                <p class="text-blue-100 text-lg">Monitoring food recalls to protect public health</p>
            </div>
            <div class="hidden md:block bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
                <div class="text-sm opacity-90">Active Monitoring</div>
                <div class="text-2xl font-bold">24/7 Protection</div>
            </div>
        </div>
    </div>

    
    <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-usda-gray-900 flex items-center">
                <span class="w-3 h-3 bg-usda-red rounded-full mr-3 animate-pulse"></span>
                Active Food Recalls
            </h2>
            <a href="/recalls" class="text-usda-blue hover:text-usda-darkblue font-medium flex items-center">
                View All Recalls
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
        </div>
        
        <% if (recalls.length > 0) { %>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <% recalls.forEach(recall => { %>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-all duration-300 border border-usda-gray-200">
                        <div class="relative">
                            <% const primaryUrl = (recall.urls && recall.urls.length > 0) ? recall.urls[0] : (recall.articleLink || ''); %>
                            <% if (primaryUrl) { %>
                                <a href="<%= primaryUrl %>" target="_blank" rel="noopener noreferrer" class="block">
                            <% } %>
                               <img src="<%= recall.categoryImage || recall.image || '/imgs/placeholder-food.png' %>" 
                                   alt="<%= recall.cleanedTitle || recall.title || 'Food Recall' %>" 
                                   class="w-full h-48 object-cover"
                                   loading="lazy"
                                   onerror="this.onerror=null;this.src='/imgs/placeholder-food.png';">
                            
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end">
                                <div class="p-4 text-white">
                                    <h3 class="font-bold text-lg leading-tight"><%= recall.cleanedTitle || recall.title %></h3>
                                </div>
                            </div>
                            <% if (primaryUrl) { %>
                                </a>
                            <% } %>
                            
                            
                            <div class="absolute top-3 right-3">
                                <% 
                                const rl = (recall.riskLevel || 'medium').toString().toLowerCase();
                                let badgeClass = 'bg-usda-green text-white'; // default low
                                let badgeText = 'Low Risk';

                                if (rl === 'high') { 
                                    badgeClass = 'bg-usda-red text-white';
                                    badgeText = 'High Risk';
                                } else if (rl === 'medium') {
                                    badgeClass = 'bg-usda-gold text-usda-gray-900';
                                    badgeText = 'Medium Risk';
                                }
                                %>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold <%= badgeClass %>">
                                    <%= badgeText %>
                                </span>
                            </div>
                        </div>
                        
                        
                        <div class="p-4">
                            <p class="text-usda-gray-600 text-sm mb-3 line-clamp-2">
                                <%= recall.cleanedReason || recall.reason || recall.description || 'No detailed description available.' %>
                            </p>
                            <div class="flex justify-between items-center text-xs text-usda-gray-500">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <% 
                                    const recallDate = recall.recallDate || recall.date || recall.report_date;
                                    if (recallDate) {
                                        const formattedDate = new Date(recallDate).toLocaleDateString();
                                    %>
                                        <%= formattedDate %>
                                    <% } else { %>
                                        Date not available
                                    <% } %>
                                </span>
                                <span class="bg-usda-gray-100 px-2 py-1 rounded">
                                    <%= recall.locations || recall.distribution || 'Various Regions' %>
                                </span>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="bg-white rounded-xl shadow-sm p-8 text-center border border-usda-gray-200">
                <div class="w-20 h-20 bg-usda-green rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-usda-gray-900 mb-2">No Active Recalls</h3>
                <p class="text-usda-gray-600 max-w-md mx-auto">There are currently no active food recalls. This system monitors multiple sources 24/7 for new alerts.</p>
            </div>
        <% } %>
    </section>

    
    <section>
        <h2 class="text-2xl font-bold text-usda-gray-900 mb-6">Recent Community Discussions</h2>
        
        <% if (posts.length > 0) { %>
            <div class="bg-white rounded-xl shadow-sm divide-y divide-usda-gray-200 border border-usda-gray-200">
                <% posts.forEach(post => { %>
                    <div class="p-6 hover:bg-usda-gray-50 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-usda-gray-900"><%= post.title %></h3>
                            <% 
                            let badgeClass = 'bg-usda-blue/10 text-usda-blue';
                            let badgeText = 'General';
                            
                            if (post.category === 'recall-discussion') {
                                badgeClass = 'bg-usda-red/10 text-usda-red';
                                badgeText = 'recall discussion';
                            } else if (post.category === 'safety-tips') {
                                badgeClass = 'bg-usda-green/10 text-usda-green';
                                badgeText = 'safety tips';
                            }
                            %>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium <%= badgeClass %>">
                                <%= badgeText %>
                            </span>
                        </div>
                        <p class="text-usda-gray-600 mb-4 line-clamp-2"><%= post.content %></p>
                        <div class="flex items-center justify-between text-sm text-usda-gray-500">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 bg-usda-blue rounded-full flex items-center justify-center">
                                    <span class="text-white text-xs font-medium">
                                        <% if (post.author && post.author.username) { %>
                                            <%= post.author.username.charAt(0).toUpperCase() %>
                                        <% } else { %>
                                            U
                                        <% } %>
                                    </span>
                                </div>
                                <span>By <%= post.author && post.author.username ? post.author.username : 'User' %></span>
                            </div>
                            <span>
                                <% if (post.createdAt) { %>
                                    <%= new Date(post.createdAt).toLocaleDateString() %>
                                <% } else { %>
                                    Recently
                                <% } %>
                            </span>
                        </div>
                    </div>
                <% }); %>
            </div>
            <div class="mt-6 text-center">
                <a href="/posts" class="inline-flex items-center text-usda-blue hover:text-usda-darkblue font-semibold">
                    Join the Discussion
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                </a>
            </div>
        <% } else { %>
            <div class="bg-white rounded-xl shadow-sm p-8 text-center border border-usda-gray-200">
                <div class="w-16 h-16 bg-usda-blue rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m5 2v5l-5-3H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v7z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-usda-gray-900 mb-2">Start the Conversation</h3>
                <p class="text-usda-gray-600 mb-4">Be the first to share food safety tips or discuss recent recalls.</p>
                <a href="/posts" class="inline-flex items-center bg-usda-blue hover:bg-usda-darkblue text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    Create First Post
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </a>
            </div>
        <% } %>
    </section>
</main>

<%- include('partials/footer') %>